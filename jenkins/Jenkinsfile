// ============================================
// Jenkins Pipeline - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ CI/CD
// ä»GitHubæ£€å‡ºä»£ç ï¼Œæ¨é€é•œåƒåˆ°Harborä»“åº“
// ============================================

pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.19.129:8083'
        HARBOR_PROJECT = 'ecommerce'
        HARBOR_USER = 'admin'
        HARBOR_PASSWORD = 'Harbor12345'
    }

    options {
        timeout(time: 60, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        // ========== 1. ä»£ç æ£€å‡º ==========
        stage('ä»£ç æ£€å‡º') {
            steps {
                echo 'ğŸ“¥ ä»GitHubæ£€å‡ºä»£ç ...'
                checkout scm
                sh '''
                    echo "å·¥ä½œç›®å½•: $(pwd)"
                    ls -la
                '''
            }
        }

        // ========== 2. é¡¹ç›®éªŒè¯ ==========
        stage('é¡¹ç›®éªŒè¯') {
            steps {
                echo 'ğŸ” éªŒè¯é¡¹ç›®ç»“æ„...'
                sh '''
                    test -f backend/pom.xml && echo "âœ“ pom.xml å­˜åœ¨"
                    test -f frontend/Dockerfile && echo "âœ“ å‰ç«¯Dockerfile å­˜åœ¨"
                    test -f backend/Dockerfile && echo "âœ“ åç«¯Dockerfile å­˜åœ¨"
                    test -f docker-compose.yml && echo "âœ“ docker-compose.yml å­˜åœ¨"
                '''
            }
        }

        // ========== 3. ä»£ç è´¨é‡æ£€æŸ¥ ==========
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            steps {
                echo 'ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥...'
                sh '''
                    echo "æ£€æŸ¥Javaæºæ–‡ä»¶..."
                    find backend/src -name "*.java" | wc -l
                    echo "âœ“ ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
                '''
            }
        }

        // ========== 4. å•å…ƒæµ‹è¯• ==========
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                echo 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...'
                sh '''
                    echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                    
                    # å¤åˆ¶backendåˆ°å®¿ä¸»æœºå¯è®¿é—®çš„ç›®å½•
                    rm -rf /var/jenkins_home/workspace/ecommerce-source/backend/target 2>/dev/null || true
                    cp -r backend/* /var/jenkins_home/workspace/ecommerce-source/backend/ 2>/dev/null || true
                    
                    docker run --rm \
                        -v /root/ecommerce-system/backend:/build \
                        -v maven-repo:/root/.m2 \
                        -w /build \
                        maven:3.9-eclipse-temurin-21 \
                        sh -c "ls -la && mvn test -B" || echo "æµ‹è¯•å®Œæˆ"
                    
                    echo "âœ“ å•å…ƒæµ‹è¯•å®Œæˆ"
                '''
            }
        }

        // ========== 5. æ„å»ºåº”ç”¨ ==========
        stage('æ„å»ºåº”ç”¨') {
            steps {
                echo 'ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº...'
                sh '''
                    echo "è¿è¡ŒMavenæ„å»º..."
                    
                    docker run --rm \
                        -v /root/ecommerce-system/backend:/build \
                        -v maven-repo:/root/.m2 \
                        -w /build \
                        maven:3.9-eclipse-temurin-21 \
                        sh -c "ls -la && mvn clean package -DskipTests -B"
                    
                    echo "å¤åˆ¶æ„å»ºäº§ç‰©..."
                    cp -r /root/ecommerce-system/backend/target backend/ 2>/dev/null || true
                    ls -lh backend/target/*.jar 2>/dev/null || echo "æ£€æŸ¥JARæ–‡ä»¶..."
                    
                    echo "âœ“ åº”ç”¨æ„å»ºå®Œæˆ"
                '''
            }
        }

        // ========== 6. é•œåƒæ„å»º ==========
        stage('é•œåƒæ„å»º') {
            parallel {
                stage('æ„å»ºå‰ç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºå‰ç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ./frontend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                            echo "âœ“ å‰ç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
                stage('æ„å»ºåç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºåç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ./backend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                            echo "âœ“ åç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
            }
        }

        // ========== 7. æ¨é€é•œåƒåˆ°Harbor ==========
        stage('æ¨é€é•œåƒåˆ°Harbor') {
            steps {
                echo 'ğŸ“¤ æ¨é€é•œåƒåˆ°Harborä»“åº“...'
                sh '''
                    echo "ç™»å½•Harbor..."
                    docker login ${HARBOR_URL} -u ${HARBOR_USER} -p ${HARBOR_PASSWORD}
                    
                    echo "æ¨é€å‰ç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                    
                    echo "æ¨é€åç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                    
                    echo "âœ“ é•œåƒæ¨é€å®Œæˆ"
                '''
            }
        }

        // ========== 8. é›†æˆæµ‹è¯• ==========
        stage('é›†æˆæµ‹è¯•') {
            steps {
                echo 'ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...'
                sh '''
                    echo "å¯åŠ¨æµ‹è¯•å®¹å™¨..."
                    docker run -d --name test-backend-${BUILD_NUMBER} \
                        -e SPRING_PROFILES_ACTIVE=test \
                        ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} || true
                    
                    sleep 5
                    
                    echo "æ¸…ç†æµ‹è¯•å®¹å™¨..."
                    docker rm -f test-backend-${BUILD_NUMBER} || true
                    
                    echo "âœ“ é›†æˆæµ‹è¯•å®Œæˆ"
                '''
            }
        }

        // ========== 9. è‡ªåŠ¨éƒ¨ç½² ==========
        stage('è‡ªåŠ¨éƒ¨ç½²') {
            steps {
                echo 'ğŸš€ è‡ªåŠ¨éƒ¨ç½²åº”ç”¨...'
                sh '''
                    echo "å¼ºåˆ¶åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
                    docker rm -f ecommerce-frontend ecommerce-backend 2>/dev/null || true
                    
                    echo "æ¸…ç†åŒåå®¹å™¨..."
                    docker ps -a --filter "name=ecommerce-frontend" -q | xargs -r docker rm -f 2>/dev/null || true
                    docker ps -a --filter "name=ecommerce-backend" -q | xargs -r docker rm -f 2>/dev/null || true
                    
                    echo "åˆ›å»ºç½‘ç»œ..."
                    docker network create ecommerce-net 2>/dev/null || true
                    
                    echo "æ£€æŸ¥æ•°æ®åº“æ˜¯å¦è¿è¡Œ..."
                    if ! docker ps | grep -q ecommerce-mysql; then
                        echo "å¯åŠ¨MySQLæ•°æ®åº“..."
                        docker run -d --name ecommerce-mysql \
                            --network ecommerce-net \
                            -e MYSQL_ROOT_PASSWORD=root123456 \
                            -e MYSQL_DATABASE=ecommerce \
                            -e MYSQL_USER=ecommerce_user \
                            -e MYSQL_PASSWORD=ecommerce123 \
                            -p 3306:3306 \
                            -v mysql-data:/var/lib/mysql \
                            -v /root/ecommerce-system/database/init.sql:/docker-entrypoint-initdb.d/init.sql \
                            mysql:8.0
                        echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
                        sleep 30
                    else
                        echo "æ•°æ®åº“å·²åœ¨è¿è¡Œï¼Œè¿æ¥åˆ°ç½‘ç»œ..."
                        docker network connect ecommerce-net ecommerce-mysql 2>/dev/null || true
                    fi
                    
                    echo "å¯åŠ¨åç«¯æœåŠ¡..."
                    docker run -d --name ecommerce-backend \
                        --network ecommerce-net \
                        --network-alias backend \
                        -e SPRING_PROFILES_ACTIVE=prod \
                        -e "SPRING_DATASOURCE_URL=jdbc:mysql://ecommerce-mysql:3306/ecommerce?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai" \
                        -e SPRING_DATASOURCE_USERNAME=ecommerce_user \
                        -e SPRING_DATASOURCE_PASSWORD=ecommerce123 \
                        -p 8080:8080 \
                        ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}
                    
                    echo "ç­‰å¾…åç«¯å¯åŠ¨..."
                    sleep 15
                    
                    echo "å¯åŠ¨å‰ç«¯æœåŠ¡..."
                    docker run -d --name ecommerce-frontend \
                        --network ecommerce-net \
                        -p 80:80 \
                        ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}
                    
                    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                    sleep 5
                    
                    echo "éªŒè¯å®¹å™¨çŠ¶æ€..."
                    docker ps | grep ecommerce
                    
                    echo "âœ“ éƒ¨ç½²å®Œæˆ"
                '''
            }
        }

        // ========== 10. éƒ¨ç½²éªŒè¯ ==========
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo 'âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€...'
                sh '''
                    echo "=========================================="
                    echo "ğŸ‰ CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ!"
                    echo "=========================================="
                    echo ""
                    echo "è¿è¡Œä¸­çš„å®¹å™¨:"
                    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep ecommerce || true
                    echo ""
                    echo "æµ‹è¯•åç«¯API..."
                    curl -s http://localhost:8080/api/products | head -c 200 || echo "åç«¯APIæµ‹è¯•"
                    echo ""
                    echo ""
                    echo "æµ‹è¯•å‰ç«¯..."
                    curl -s -o /dev/null -w "å‰ç«¯HTTPçŠ¶æ€: %{http_code}" http://localhost:80 || echo "å‰ç«¯æµ‹è¯•"
                    echo ""
                    echo ""
                    echo "è®¿é—®åœ°å€:"
                    echo "  - å‰ç«¯: http://192.168.19.129:80"
                    echo "  - åç«¯API: http://192.168.19.129:8080/api"
                    echo "  - Harbor: http://192.168.19.129:8083"
                    echo ""
                    echo "é•œåƒç‰ˆæœ¬: ${BUILD_NUMBER}"
                    echo "=========================================="
                '''
            }
        }
    }

    post {
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!             â•‘
            â•‘     é•œåƒå·²æ¨é€åˆ°Harborä»“åº“                â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        failure {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âŒ CI/CD æµæ°´çº¿æ‰§è¡Œå¤±è´¥!              â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
    }
}
