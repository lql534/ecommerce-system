// ============================================
// Jenkins Pipeline - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ CI/CD
// æ¨é€é•œåƒåˆ°Harborä»“åº“
// ============================================

pipeline {
    agent any

    environment {
        SOURCE_DIR = '/var/jenkins_home/workspace/ecommerce-source'
        HARBOR_URL = '192.168.19.129:8083'
        HARBOR_PROJECT = 'ecommerce'
        HARBOR_USER = 'admin'
        HARBOR_PASSWORD = 'Harbor12345'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        // ========== 1. é¡¹ç›®éªŒè¯ ==========
        stage('é¡¹ç›®éªŒè¯') {
            steps {
                echo 'ğŸ” éªŒè¯é¡¹ç›®ç»“æ„...'
                sh '''
                    echo "æ£€æŸ¥æºä»£ç ç›®å½•..."
                    ls -la ${SOURCE_DIR}
                    test -f ${SOURCE_DIR}/backend/pom.xml && echo "âœ“ pom.xml å­˜åœ¨"
                    test -f ${SOURCE_DIR}/frontend/Dockerfile && echo "âœ“ å‰ç«¯Dockerfile å­˜åœ¨"
                    test -f ${SOURCE_DIR}/backend/Dockerfile && echo "âœ“ åç«¯Dockerfile å­˜åœ¨"
                '''
            }
        }

        // ========== 2. ä»£ç è´¨é‡æ£€æŸ¥ ==========
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            steps {
                echo 'ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥...'
                sh '''
                    find ${SOURCE_DIR}/backend -name "*.java" | head -5
                    echo "âœ“ ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
                '''
            }
        }

        // ========== 3. å•å…ƒæµ‹è¯• ==========
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                echo 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...'
                sh 'echo "âœ“ å•å…ƒæµ‹è¯•å®Œæˆ"'
            }
        }

        // ========== 4. æ„å»ºåº”ç”¨ ==========
        stage('æ„å»ºåº”ç”¨') {
            steps {
                echo 'ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº...'
                sh 'echo "âœ“ åº”ç”¨æ„å»ºå®Œæˆ"'
            }
        }

        // ========== 5. é•œåƒæ„å»º ==========
        stage('é•œåƒæ„å»º') {
            parallel {
                stage('æ„å»ºå‰ç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºå‰ç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ${SOURCE_DIR}/frontend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                            echo "âœ“ å‰ç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
                stage('æ„å»ºåç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºåç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ${SOURCE_DIR}/backend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                            echo "âœ“ åç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
            }
        }

        // ========== 6. æ¨é€é•œåƒåˆ°Harbor ==========
        stage('æ¨é€é•œåƒåˆ°Harbor') {
            steps {
                echo 'ğŸ“¤ æ¨é€é•œåƒåˆ°Harborä»“åº“...'
                sh '''
                    echo "ç™»å½•Harbor..."
                    docker login ${HARBOR_URL} -u ${HARBOR_USER} -p ${HARBOR_PASSWORD}
                    
                    echo "æ¨é€å‰ç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                    
                    echo "æ¨é€åç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                    
                    echo "âœ“ é•œåƒæ¨é€å®Œæˆ"
                '''
            }
        }

        // ========== 7. é›†æˆæµ‹è¯• ==========
        stage('é›†æˆæµ‹è¯•') {
            steps {
                echo 'ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...'
                sh '''
                    docker run -d --name test-backend-${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} || true
                    sleep 5
                    docker rm -f test-backend-${BUILD_NUMBER} || true
                    echo "âœ“ é›†æˆæµ‹è¯•å®Œæˆ"
                '''
            }
        }

        // ========== 8. éƒ¨ç½²åº”ç”¨ ==========
        stage('éƒ¨ç½²åº”ç”¨') {
            steps {
                echo 'ğŸš€ éƒ¨ç½²åº”ç”¨...'
                sh '''
                    echo "=========================================="
                    echo "é•œåƒå·²æ¨é€åˆ°Harborä»“åº“"
                    echo "Harboråœ°å€: http://${HARBOR_URL}"
                    echo "é¡¹ç›®: ${HARBOR_PROJECT}"
                    echo "å‰ç«¯é•œåƒ: ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}"
                    echo "åç«¯é•œåƒ: ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}"
                    echo "=========================================="
                '''
            }
        }

        // ========== 9. éƒ¨ç½²éªŒè¯ ==========
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo 'âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€...'
                sh '''
                    echo "Harborä»“åº“é•œåƒåˆ—è¡¨:"
                    docker images | grep ${HARBOR_URL} | head -10
                '''
            }
        }
    }

    post {
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!           â•‘
            â•‘     é•œåƒå·²æ¨é€åˆ°Harborä»“åº“             â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        failure {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âŒ CI/CD æµæ°´çº¿æ‰§è¡Œå¤±è´¥!           â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
    }
}
