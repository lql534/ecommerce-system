// ============================================
// Jenkins Pipeline - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ CI/CD
// ä»GitHubæ£€å‡ºä»£ç ï¼Œæ¨é€é•œåƒåˆ°Harborä»“åº“
// ============================================

pipeline {
    agent any

    environment {
        HARBOR_URL = '192.168.19.129:8083'
        HARBOR_PROJECT = 'ecommerce'
        HARBOR_USER = 'admin'
        HARBOR_PASSWORD = 'Harbor12345'
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        // ========== 1. ä»£ç æ£€å‡º ==========
        stage('ä»£ç æ£€å‡º') {
            steps {
                echo 'ğŸ“¥ ä»GitHubæ£€å‡ºä»£ç ...'
                checkout scm
                sh '''
                    echo "å·¥ä½œç›®å½•: $(pwd)"
                    ls -la
                '''
            }
        }

        // ========== 2. é¡¹ç›®éªŒè¯ ==========
        stage('é¡¹ç›®éªŒè¯') {
            steps {
                echo 'ğŸ” éªŒè¯é¡¹ç›®ç»“æ„...'
                sh '''
                    test -f backend/pom.xml && echo "âœ“ pom.xml å­˜åœ¨"
                    test -f frontend/Dockerfile && echo "âœ“ å‰ç«¯Dockerfile å­˜åœ¨"
                    test -f backend/Dockerfile && echo "âœ“ åç«¯Dockerfile å­˜åœ¨"
                    test -f docker-compose.yml && echo "âœ“ docker-compose.yml å­˜åœ¨"
                '''
            }
        }

        // ========== 3. ä»£ç è´¨é‡æ£€æŸ¥ ==========
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            steps {
                echo 'ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥...'
                sh '''
                    echo "æ£€æŸ¥Javaæºæ–‡ä»¶..."
                    find backend/src -name "*.java" | wc -l
                    echo "âœ“ ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
                '''
            }
        }

        // ========== 4. å•å…ƒæµ‹è¯• ==========
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                echo 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...'
                sh '''
                    echo "å½“å‰ç›®å½•: $(pwd)"
                    echo "æ£€æŸ¥backendç›®å½•..."
                    ls -la backend/
                    
                    echo "æ‹‰å–Mavené•œåƒ..."
                    docker pull maven:3.9-eclipse-temurin-21 || echo "ä½¿ç”¨å·²æœ‰é•œåƒ"
                    
                    echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
                    docker run --rm \
                        -v "$(pwd)/backend":/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        maven:3.9-eclipse-temurin-21 \
                        mvn test -B -e
                    
                    echo "âœ“ å•å…ƒæµ‹è¯•å®Œæˆ"
                '''
            }
        }

        // ========== 5. æ„å»ºåº”ç”¨ ==========
        stage('æ„å»ºåº”ç”¨') {
            steps {
                echo 'ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº...'
                sh '''
                    echo "å½“å‰ç›®å½•: $(pwd)"
                    
                    echo "è¿è¡ŒMavenæ„å»º..."
                    docker run --rm \
                        -v "$(pwd)/backend":/app \
                        -v maven-repo:/root/.m2 \
                        -w /app \
                        maven:3.9-eclipse-temurin-21 \
                        mvn clean package -DskipTests -B -e
                    
                    echo "æ£€æŸ¥æ„å»ºäº§ç‰©..."
                    ls -lh backend/target/*.jar || echo "JARæ–‡ä»¶åˆ—è¡¨"
                    
                    echo "âœ“ åº”ç”¨æ„å»ºå®Œæˆ"
                '''
            }
        }

        // ========== 6. é•œåƒæ„å»º ==========
        stage('é•œåƒæ„å»º') {
            parallel {
                stage('æ„å»ºå‰ç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºå‰ç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ./frontend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                            echo "âœ“ å‰ç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
                stage('æ„å»ºåç«¯é•œåƒ') {
                    steps {
                        echo 'ğŸ³ æ„å»ºåç«¯Dockeré•œåƒ...'
                        sh '''
                            docker build -t ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ./backend
                            docker tag ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                            echo "âœ“ åç«¯é•œåƒæ„å»ºå®Œæˆ"
                        '''
                    }
                }
            }
        }

        // ========== 7. æ¨é€é•œåƒåˆ°Harbor ==========
        stage('æ¨é€é•œåƒåˆ°Harbor') {
            steps {
                echo 'ğŸ“¤ æ¨é€é•œåƒåˆ°Harborä»“åº“...'
                sh '''
                    echo "ç™»å½•Harbor..."
                    docker login ${HARBOR_URL} -u ${HARBOR_USER} -p ${HARBOR_PASSWORD}
                    
                    echo "æ¨é€å‰ç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:latest
                    
                    echo "æ¨é€åç«¯é•œåƒ..."
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}
                    docker push ${HARBOR_URL}/${HARBOR_PROJECT}/backend:latest
                    
                    echo "âœ“ é•œåƒæ¨é€å®Œæˆ"
                '''
            }
        }

        // ========== 8. é›†æˆæµ‹è¯• ==========
        stage('é›†æˆæµ‹è¯•') {
            steps {
                echo 'ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...'
                sh '''
                    echo "å¯åŠ¨æµ‹è¯•å®¹å™¨..."
                    docker run -d --name test-backend-${BUILD_NUMBER} \
                        -e SPRING_PROFILES_ACTIVE=test \
                        ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER} || true
                    
                    sleep 5
                    
                    echo "æ¸…ç†æµ‹è¯•å®¹å™¨..."
                    docker rm -f test-backend-${BUILD_NUMBER} || true
                    
                    echo "âœ“ é›†æˆæµ‹è¯•å®Œæˆ"
                '''
            }
        }

        // ========== 9. éƒ¨ç½²éªŒè¯ ==========
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo 'âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€...'
                sh '''
                    echo "=========================================="
                    echo "ğŸ‰ CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ!"
                    echo "=========================================="
                    echo "Harboråœ°å€: http://${HARBOR_URL}"
                    echo "é¡¹ç›®: ${HARBOR_PROJECT}"
                    echo "æ„å»ºç¼–å·: ${BUILD_NUMBER}"
                    echo ""
                    echo "é•œåƒåˆ—è¡¨:"
                    echo "  - ${HARBOR_URL}/${HARBOR_PROJECT}/frontend:${BUILD_NUMBER}"
                    echo "  - ${HARBOR_URL}/${HARBOR_PROJECT}/backend:${BUILD_NUMBER}"
                    echo "=========================================="
                '''
            }
        }
    }

    post {
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âœ… CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!           â•‘
            â•‘     é•œåƒå·²æ¨é€åˆ°Harborä»“åº“             â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        failure {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘     âŒ CI/CD æµæ°´çº¿æ‰§è¡Œå¤±è´¥!           â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
    }
}
