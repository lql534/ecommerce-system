// ============================================
// Jenkins Pipeline - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ CI/CD
// ============================================

pipeline {
    agent any

    environment {
        // Dockeré•œåƒä»“åº“é…ç½®
        REGISTRY_URL = 'localhost:5000'
        IMAGE_PREFIX = 'ecommerce-system'
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // æ•°æ®åº“é…ç½®
        MYSQL_ROOT_PASSWORD = credentials('mysql-root-password')
        MYSQL_USER = 'ecommerce_user'
        MYSQL_PASSWORD = credentials('mysql-password')
        
        // Docker Composeé¡¹ç›®å
        COMPOSE_PROJECT_NAME = 'ecommerce'
    }

    options {
        // æ„å»ºè¶…æ—¶æ—¶é—´
        timeout(time: 30, unit: 'MINUTES')
        // ä¿ç•™æ„å»ºå†å²
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // ç¦æ­¢å¹¶å‘æ„å»º
        disableConcurrentBuilds()
    }

    stages {
        // ==================== ä»£ç æ£€å‡º ====================
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ æ£€å‡ºä»£ç ...'
                checkout scm
            }
        }

        // ==================== ä»£ç è´¨é‡æ£€æŸ¥ ====================
        stage('Code Quality') {
            steps {
                echo 'ğŸ” ä»£ç è´¨é‡æ£€æŸ¥...'
                dir('backend') {
                    sh 'mvn checkstyle:check -q || true'
                }
            }
        }

        // ==================== å•å…ƒæµ‹è¯• ====================
        stage('Unit Tests') {
            steps {
                echo 'ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•...'
                dir('backend') {
                    sh 'mvn test -B'
                }
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
                    junit allowEmptyResults: true, testResults: 'backend/target/surefire-reports/*.xml'
                    // å‘å¸ƒä»£ç è¦†ç›–ç‡æŠ¥å‘Š
                    jacoco(
                        execPattern: 'backend/target/jacoco.exec',
                        classPattern: 'backend/target/classes',
                        sourcePattern: 'backend/src/main/java',
                        exclusionPattern: 'backend/src/test*'
                    )
                }
            }
        }

        // ==================== æ„å»ºåº”ç”¨ ====================
        stage('Build Application') {
            steps {
                echo 'ğŸ”¨ æ„å»ºåº”ç”¨...'
                dir('backend') {
                    sh 'mvn clean package -DskipTests -B'
                }
            }
        }

        // ==================== æ„å»ºDockeré•œåƒ ====================
        stage('Build Docker Images') {
            parallel {
                stage('Build Frontend Image') {
                    steps {
                        echo 'ğŸ³ æ„å»ºå‰ç«¯é•œåƒ...'
                        dir('frontend') {
                            sh """
                                docker build -t ${REGISTRY_URL}/${IMAGE_PREFIX}-frontend:${IMAGE_TAG} .
                                docker tag ${REGISTRY_URL}/${IMAGE_PREFIX}-frontend:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_PREFIX}-frontend:latest
                            """
                        }
                    }
                }
                stage('Build Backend Image') {
                    steps {
                        echo 'ğŸ³ æ„å»ºåç«¯é•œåƒ...'
                        dir('backend') {
                            sh """
                                docker build -t ${REGISTRY_URL}/${IMAGE_PREFIX}-backend:${IMAGE_TAG} .
                                docker tag ${REGISTRY_URL}/${IMAGE_PREFIX}-backend:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_PREFIX}-backend:latest
                            """
                        }
                    }
                }
                stage('Build MySQL Image') {
                    steps {
                        echo 'ğŸ³ æ„å»ºæ•°æ®åº“é•œåƒ...'
                        dir('database') {
                            sh """
                                docker build -t ${REGISTRY_URL}/${IMAGE_PREFIX}-mysql:${IMAGE_TAG} .
                                docker tag ${REGISTRY_URL}/${IMAGE_PREFIX}-mysql:${IMAGE_TAG} ${REGISTRY_URL}/${IMAGE_PREFIX}-mysql:latest
                            """
                        }
                    }
                }
            }
        }

        // ==================== æ¨é€é•œåƒåˆ°ä»“åº“ ====================
        stage('Push Images') {
            steps {
                echo 'ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“...'
                sh """
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-frontend:${IMAGE_TAG}
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-frontend:latest
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-backend:${IMAGE_TAG}
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-backend:latest
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-mysql:${IMAGE_TAG}
                    docker push ${REGISTRY_URL}/${IMAGE_PREFIX}-mysql:latest
                """
            }
        }

        // ==================== é›†æˆæµ‹è¯• ====================
        stage('Integration Tests') {
            steps {
                echo 'ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•...'
                sh """
                    # å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
                    docker compose -f docker-compose.yml up -d
                    
                    # ç­‰å¾…æœåŠ¡å¯åŠ¨
                    sleep 60
                    
                    # å¥åº·æ£€æŸ¥
                    curl -f http://localhost:8080/actuator/health || exit 1
                    curl -f http://localhost:80/health || exit 1
                    
                    # APIæµ‹è¯•
                    curl -f http://localhost:8080/api/products || exit 1
                """
            }
            post {
                always {
                    sh 'docker compose -f docker-compose.yml down -v || true'
                }
            }
        }

        // ==================== éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ ====================
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                echo 'ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ...'
                input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ?', ok: 'éƒ¨ç½²'
                sh """
                    docker compose -f docker-compose.yml pull
                    docker compose -f docker-compose.yml up -d --force-recreate
                """
            }
        }
    }

    post {
        success {
            echo 'âœ… æ„å»ºæˆåŠŸ!'
            // å¯ä»¥æ·»åŠ é€šçŸ¥ï¼Œå¦‚é‚®ä»¶ã€é’‰é’‰ç­‰
        }
        failure {
            echo 'âŒ æ„å»ºå¤±è´¥!'
            // å¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
        }
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
        }
    }
}
