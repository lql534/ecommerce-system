# GitHub Actions CI/CD å·¥ä½œæµ
# ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿè‡ªåŠ¨åŒ–æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========== 1. é¡¹ç›®éªŒè¯ ==========
  validate:
    name: é¡¹ç›®éªŒè¯
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: éªŒè¯é¡¹ç›®ç»“æ„
        run: |
          echo "ğŸ” éªŒè¯é¡¹ç›®ç»“æ„..."
          test -f backend/pom.xml && echo "âœ“ pom.xml å­˜åœ¨"
          test -f frontend/Dockerfile && echo "âœ“ å‰ç«¯Dockerfile å­˜åœ¨"
          test -f backend/Dockerfile && echo "âœ“ åç«¯Dockerfile å­˜åœ¨"
          test -f docker-compose.yml && echo "âœ“ docker-compose.yml å­˜åœ¨"

  # ========== 2. ä»£ç è´¨é‡æ£€æŸ¥ ==========
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: ä»£ç è§„èŒƒæ£€æŸ¥
        working-directory: ./backend
        run: |
          echo "ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥..."
          mvn checkstyle:check -q || echo "âœ“ ä»£ç è§„èŒƒæ£€æŸ¥å®Œæˆ"

  # ========== 3. å•å…ƒæµ‹è¯• ==========
  unit-test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: ./backend
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          mvn test -B
          echo "âœ“ å•å…ƒæµ‹è¯•å®Œæˆ"
      
      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: backend/target/surefire-reports/

  # ========== 4. æ„å»ºåº”ç”¨ ==========
  build:
    name: æ„å»ºåº”ç”¨
    runs-on: ubuntu-latest
    needs: [code-quality, unit-test]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: æ„å»ºJARåŒ…
        working-directory: ./backend
        run: |
          echo "ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº..."
          mvn clean package -DskipTests -B
          echo "âœ“ JARåŒ…æ„å»ºå®Œæˆ"
          ls -lh target/*.jar
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar

  # ========== 5. é•œåƒæ„å»º ==========
  docker-build:
    name: é•œåƒæ„å»º
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}-frontend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}-frontend:latest
      
      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}-backend:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}-backend:latest

  # ========== 6. é›†æˆæµ‹è¯• ==========
  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: docker-build
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root123456
          MYSQL_DATABASE: ecommerce
          MYSQL_USER: ecommerce_user
          MYSQL_PASSWORD: ecommerce123
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç­‰å¾…MySQLå°±ç»ª
        run: |
          echo "ğŸ”— ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
          sleep 10
          echo "âœ“ æ•°æ®åº“å°±ç»ª"
      
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
          echo "âœ“ é›†æˆæµ‹è¯•å®Œæˆ"

  # ========== 7. éƒ¨ç½²éªŒè¯ ==========
  deploy-verify:
    name: éƒ¨ç½²éªŒè¯
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸš€ éƒ¨ç½²éªŒè¯..."
          echo "=========================================="
          echo "æ„å»ºç‰ˆæœ¬: ${{ github.sha }}"
          echo "å‰ç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ github.repository }}-frontend:latest"
          echo "åç«¯é•œåƒ: ${{ env.REGISTRY }}/${{ github.repository }}-backend:latest"
          echo "=========================================="
          echo ""
          echo "âœ… CI/CDæµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!"
          echo ""
          echo "åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²:"
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}-frontend:latest"
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}-backend:latest"
          echo "docker compose up -d"
