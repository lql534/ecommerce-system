<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å• - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">ğŸ›’ ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <nav class="nav">
                <a href="index.html">å•†å“åˆ—è¡¨</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html" class="active">ğŸ“‹ æˆ‘çš„è®¢å•</a>
                <span id="userNav"></span>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <h2 style="margin-bottom: 20px;">ğŸ“‹ æˆ‘çš„è®¢å•</h2>
            
            <div class="toolbar">
                <select id="statusFilter" class="filter-select" onchange="loadOrders()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="PENDING">å¾…ä»˜æ¬¾</option>
                    <option value="PAID">å·²ä»˜æ¬¾</option>
                    <option value="SHIPPED">å·²å‘è´§</option>
                    <option value="DELIVERED">å·²é€è¾¾</option>
                    <option value="CANCELLED">å·²å–æ¶ˆ</option>
                </select>
            </div>

            <div id="orderList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeOrderDetail()">&times;</span>
            <div id="orderDetailContent"></div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ - DockeræœŸæœ«é¡¹ç›®</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        var statusMap = {
            'PENDING': { text: 'â³ å¾…ä»˜æ¬¾', className: 'status-pending' },
            'PAID': { text: 'âœ… å·²ä»˜æ¬¾', className: 'status-paid' },
            'SHIPPED': { text: 'ğŸšš å·²å‘è´§', className: 'status-shipped' },
            'DELIVERED': { text: 'ğŸ“¦ å·²é€è¾¾', className: 'status-delivered' },
            'CANCELLED': { text: 'âŒ å·²å–æ¶ˆ', className: 'status-cancelled' }
        };

        document.addEventListener('DOMContentLoaded', function() {
            updateUserNav();
            loadOrders();
        });

        function updateUserNav() {
            var userNav = document.getElementById('userNav');
            var user = userStore.getUser();
            if (user) {
                userNav.innerHTML = '<span style="color:#fff;margin-right:10px;">ğŸ‘¤ ' + user.username + '</span>' +
                    '<a href="#" onclick="logout()">é€€å‡º</a>';
            } else {
                userNav.innerHTML = '<a href="index.html">è¯·å…ˆç™»å½•</a>';
            }
        }

        function loadOrders() {
            var user = userStore.getUser();
            if (!user) {
                document.getElementById('orderList').innerHTML = 
                    '<div class="empty-state">' +
                    '<p>è¯·å…ˆ <a href="index.html">ç™»å½•</a> åæŸ¥çœ‹è®¢å•</p>' +
                    '</div>';
                return;
            }

            api.getUserOrders(user.id)
                .then(function(orders) {
                    var statusFilter = document.getElementById('statusFilter').value;
                    
                    var filteredOrders = orders;
                    if (statusFilter) {
                        filteredOrders = orders.filter(function(o) {
                            return o.status === statusFilter;
                        });
                    }
                    
                    renderOrders(filteredOrders);
                })
                .catch(function(error) {
                    document.getElementById('orderList').innerHTML = 
                        '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
                });
        }

        function renderOrders(orders) {
            var container = document.getElementById('orderList');
            
            if (orders.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state">' +
                    '<p>ğŸ“‹ æš‚æ— è®¢å•</p>' +
                    '<a href="index.html" class="btn btn-primary">å»è´­ç‰©</a>' +
                    '</div>';
                return;
            }

            var html = '';
            orders.forEach(function(order) {
                var status = statusMap[order.status] || { text: order.status, className: '' };
                
                html += '<div class="order-card">' +
                    '<div class="order-header">' +
                    '<span class="order-no">è®¢å•å·ï¼š' + order.orderNo + '</span>' +
                    '<span class="order-status ' + status.className + '">' + status.text + '</span>' +
                    '</div>' +
                    '<div class="order-info">' +
                    '<p>ä¸‹å•æ—¶é—´ï¼š' + formatDate(order.createdAt) + '</p>' +
                    '<p>è®¢å•é‡‘é¢ï¼š<span class="order-amount">Â¥' + order.totalAmount.toFixed(2) + '</span></p>' +
                    (order.shippingAddress ? '<p>æ”¶è´§åœ°å€ï¼š' + order.shippingAddress + '</p>' : '') +
                    '</div>' +
                    '<div class="order-actions">' +
                    '<button onclick="viewOrderDetail(' + order.id + ')" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</button>';
                
                if (order.status === 'PENDING') {
                    html += '<button onclick="payOrder(' + order.id + ')" class="btn btn-secondary btn-sm">ğŸ’³ ç«‹å³æ”¯ä»˜</button>' +
                        '<button onclick="cancelOrder(' + order.id + ')" class="btn btn-danger btn-sm">å–æ¶ˆè®¢å•</button>';
                }
                
                if (order.status === 'SHIPPED') {
                    html += '<button onclick="confirmDelivery(' + order.id + ')" class="btn btn-secondary btn-sm">ğŸ“¦ ç¡®è®¤æ”¶è´§</button>';
                }
                
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        function viewOrderDetail(orderId) {
            api.getOrder(orderId)
                .then(function(order) {
                    var status = statusMap[order.status] || { text: order.status, className: '' };
                    
                    var itemsHtml = '';
                    if (order.items && order.items.length > 0) {
                        order.items.forEach(function(item) {
                            itemsHtml += '<div class="order-item">' +
                                '<span>' + item.productName + '</span>' +
                                '<span>Â¥' + item.productPrice.toFixed(2) + ' x ' + item.quantity + '</span>' +
                                '<span>Â¥' + item.subtotal.toFixed(2) + '</span>' +
                                '</div>';
                        });
                    }

                    document.getElementById('orderDetailContent').innerHTML = 
                        '<h2>ğŸ“‹ è®¢å•è¯¦æƒ…</h2>' +
                        '<div class="order-detail">' +
                        '<p><strong>è®¢å•å·ï¼š</strong>' + order.orderNo + '</p>' +
                        '<p><strong>çŠ¶æ€ï¼š</strong><span class="' + status.className + '">' + status.text + '</span></p>' +
                        '<p><strong>ä¸‹å•æ—¶é—´ï¼š</strong>' + formatDate(order.createdAt) + '</p>' +
                        (order.paidAt ? '<p><strong>æ”¯ä»˜æ—¶é—´ï¼š</strong>' + formatDate(order.paidAt) + '</p>' : '') +
                        (order.shippedAt ? '<p><strong>å‘è´§æ—¶é—´ï¼š</strong>' + formatDate(order.shippedAt) + '</p>' : '') +
                        (order.deliveredAt ? '<p><strong>é€è¾¾æ—¶é—´ï¼š</strong>' + formatDate(order.deliveredAt) + '</p>' : '') +
                        '<p><strong>æ”¶è´§åœ°å€ï¼š</strong>' + (order.shippingAddress || 'æ— ') + '</p>' +
                        (order.remark ? '<p><strong>å¤‡æ³¨ï¼š</strong>' + order.remark + '</p>' : '') +
                        '<h3 style="margin-top:20px;">å•†å“æ˜ç»†</h3>' +
                        '<div class="order-items-list">' + itemsHtml + '</div>' +
                        '<div class="order-total">' +
                        '<strong>è®¢å•æ€»é¢ï¼šÂ¥' + order.totalAmount.toFixed(2) + '</strong>' +
                        '</div>' +
                        '</div>';
                    
                    document.getElementById('orderDetailModal').classList.add('show');
                })
                .catch(function(error) {
                    alert('è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
                });
        }

        function closeOrderDetail() {
            document.getElementById('orderDetailModal').classList.remove('show');
        }

        function payOrder(orderId) {
            if (!confirm('ç¡®è®¤æ”¯ä»˜æ­¤è®¢å•ï¼Ÿ')) return;
            
            api.payOrder(orderId)
                .then(function() {
                    alert('âœ… æ”¯ä»˜æˆåŠŸï¼');
                    loadOrders();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function cancelOrder(orderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ')) return;
            
            api.cancelOrder(orderId)
                .then(function() {
                    alert('âœ… è®¢å•å·²å–æ¶ˆ');
                    loadOrders();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function confirmDelivery(orderId) {
            if (!confirm('ç¡®è®¤å·²æ”¶åˆ°å•†å“ï¼Ÿ')) return;
            
            api.deliverOrder(orderId)
                .then(function() {
                    alert('âœ… å·²ç¡®è®¤æ”¶è´§');
                    loadOrders();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            var date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }

        function logout() {
            userStore.clearUser();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
