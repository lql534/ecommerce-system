<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ v2.0</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">ğŸ›’ ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <nav class="nav">
                <a href="index.html" class="active">å•†å“åˆ—è¡¨</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦ <span id="cartCount" class="badge">0</span></a>
                <a href="orders.html">ğŸ“‹ æˆ‘çš„è®¢å•</a>
                <a href="#" id="loginBtn" onclick="showLoginModal()">ğŸ” ç™»å½•</a>
                <span id="userInfo" style="display:none;">
                    <span id="userName" style="color:#fff;"></span>
                    <a href="#" onclick="logout()" style="margin-left:10px;">é€€å‡º</a>
                </span>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <input type="text" id="searchInput" placeholder="æœç´¢å•†å“..." class="search-input">
                <select id="categoryFilter" class="filter-select">
                    <option value="">å…¨éƒ¨åˆ†ç±»</option>
                    <option value="ç”µå­äº§å“">ç”µå­äº§å“</option>
                    <option value="æœè£…">æœè£…</option>
                    <option value="é£Ÿå“">é£Ÿå“</option>
                    <option value="å®¶å±…">å®¶å±…</option>
                </select>
                <button onclick="loadProducts()" class="btn btn-primary">åˆ·æ–°</button>
                <button id="addProductBtn" onclick="openAddModal()" class="btn btn-secondary" style="display:none;">+ æ·»åŠ å•†å“</button>
                <a href="admin.html" id="adminLink" class="btn btn-secondary" style="display:none;">ç®¡ç†åå°</a>
            </div>

            <!-- å•†å“åˆ—è¡¨ -->
            <div id="productList" class="product-grid">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>

            <!-- åˆ†é¡µ -->
            <div id="pagination" class="pagination"></div>
        </div>
    </main>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2>ğŸ‘¤ ç”¨æˆ·ç™»å½•</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">ç™»å½•</button>
            </form>
            <div style="margin-top:20px;padding:15px;background:#f5f5f5;border-radius:8px;">
                <p style="font-weight:bold;margin-bottom:10px;">æµ‹è¯•è´¦å·ï¼š</p>
                <p>ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜ï¼šadmin / admin123</p>
                <p>ğŸ‘¤ æ™®é€šç”¨æˆ·ï¼šuser1 / user123</p>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å•†å“æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 id="editModalTitle">ç¼–è¾‘å•†å“</h2>
            <form id="editForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>å•†å“åç§° <span class="required">*</span></label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>å•†å“æè¿°</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä»·æ ¼ <span class="required">*</span></label>
                        <input type="number" id="editPrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>åº“å­˜ <span class="required">*</span></label>
                        <input type="number" id="editStock" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="editCategory">
                        <option value="ç”µå­äº§å“">ç”µå­äº§å“</option>
                        <option value="æœè£…">æœè£…</option>
                        <option value="é£Ÿå“">é£Ÿå“</option>
                        <option value="å®¶å±…">å®¶å±…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡URL</label>
                    <input type="text" id="editImageUrl" placeholder="/images/å•†å“åç§°.jpg">
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ - DockeræœŸæœ«é¡¹ç›®</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 12;
        let totalPages = 1;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            initApp();
            loadProducts();
            setupEventListeners();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            const user = userStore.getUser();
            console.log('å½“å‰ç”¨æˆ·:', user);
            updateUI();
            updateCartCount();
        }

        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
        function updateUI() {
            const user = userStore.getUser();
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const addProductBtn = document.getElementById('addProductBtn');
            const adminLink = document.getElementById('adminLink');

            if (user) {
                // å·²ç™»å½•
                loginBtn.style.display = 'none';
                userInfo.style.display = 'inline';
                userName.textContent = 'ğŸ‘¤ ' + user.username;
                
                // ç®¡ç†å‘˜æ˜¾ç¤ºç®¡ç†æŒ‰é’®
                if (user.role === 'ADMIN') {
                    addProductBtn.style.display = 'inline-block';
                    adminLink.style.display = 'inline-block';
                } else {
                    addProductBtn.style.display = 'none';
                    adminLink.style.display = 'none';
                }
            } else {
                // æœªç™»å½•
                loginBtn.style.display = 'inline';
                userInfo.style.display = 'none';
                addProductBtn.style.display = 'none';
                adminLink.style.display = 'none';
            }
        }

        // æ›´æ–°è´­ç‰©è½¦æ•°é‡
        async function updateCartCount() {
            const badge = document.getElementById('cartCount');
            const user = userStore.getUser();
            
            if (!user) {
                badge.textContent = '0';
                return;
            }
            
            try {
                const items = await api.getCart(user.id);
                const count = items.reduce((sum, item) => sum + item.quantity, 0);
                badge.textContent = count;
            } catch (e) {
                console.error('è·å–è´­ç‰©è½¦å¤±è´¥:', e);
                badge.textContent = '0';
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let debounceTimer;
                searchInput.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(function() {
                        currentPage = 1;
                        loadProducts();
                    }, 300);
                });
            }

            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.addEventListener('change', function() {
                    currentPage = 1;
                    loadProducts();
                });
            }
        }

        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const keyword = document.getElementById('searchInput').value || '';
                const category = document.getElementById('categoryFilter').value || '';

                const params = { page: currentPage - 1, size: pageSize };
                if (keyword) params.keyword = keyword;
                if (category) params.category = category;

                const data = await api.getProducts(params);
                
                let products = [];
                if (Array.isArray(data)) {
                    products = data;
                    totalPages = 1;
                } else if (data.content) {
                    products = data.content;
                    totalPages = data.totalPages || 1;
                }

                renderProducts(products);
                renderPagination();
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', error);
                productList.innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts(products) {
            const productList = document.getElementById('productList');
            const user = userStore.getUser();
            const isLoggedIn = !!user;
            const isAdmin = user && user.role === 'ADMIN';
            
            if (!products || products.length === 0) {
                productList.innerHTML = '<div class="loading">æš‚æ— å•†å“æ•°æ®</div>';
                return;
            }

            let html = '';
            products.forEach(function(product) {
                html += '<div class="product-card">';
                html += '<img src="' + (product.imageUrl || '/images/default.jpg') + '" alt="' + product.name + '" class="product-image" onerror="this.src=\'/images/default.jpg\'">';
                html += '<div class="product-info">';
                html += '<h3 class="product-name">' + escapeHtml(product.name) + '</h3>';
                html += '<p class="product-category"><span class="category-tag">' + escapeHtml(product.category || 'æœªåˆ†ç±»') + '</span></p>';
                html += '<p class="product-price">Â¥' + (product.price ? product.price.toFixed(2) : '0.00') + '</p>';
                
                if (product.stock > 0) {
                    html += '<p class="product-stock"><span class="in-stock">åº“å­˜: ' + product.stock + '</span></p>';
                } else {
                    html += '<p class="product-stock"><span class="out-of-stock">ç¼ºè´§</span></p>';
                }
                
                html += '<div class="product-actions">';
                html += '<button onclick="viewProduct(' + product.id + ')" class="btn btn-primary btn-sm">æŸ¥çœ‹è¯¦æƒ…</button>';
                
                // å·²ç™»å½•ä¸”æœ‰åº“å­˜æ‰æ˜¾ç¤ºåŠ è´­æŒ‰é’®
                if (isLoggedIn && product.stock > 0) {
                    html += '<button onclick="addToCart(' + product.id + ')" class="btn btn-secondary btn-sm">ğŸ›’ åŠ è´­</button>';
                }
                
                // ç®¡ç†å‘˜æ˜¾ç¤ºç¼–è¾‘åˆ é™¤æŒ‰é’®
                if (isAdmin) {
                    html += '<button onclick="openEditModal(' + product.id + ')" class="btn btn-secondary btn-sm">ç¼–è¾‘</button>';
                    html += '<button onclick="deleteProduct(' + product.id + ')" class="btn btn-danger btn-sm">åˆ é™¤</button>';
                }
                
                html += '</div></div></div>';
            });

            productList.innerHTML = html;
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '<button onclick="goToPage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + '>ä¸Šä¸€é¡µ</button>';
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += '<button onclick="goToPage(' + i + ')" class="' + (i === currentPage ? 'active' : '') + '">' + i + '</button>';
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<button disabled>...</button>';
                }
            }
            
            html += '<button onclick="goToPage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '>ä¸‹ä¸€é¡µ</button>';
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadProducts();
        }

        // æŸ¥çœ‹å•†å“è¯¦æƒ…
        function viewProduct(id) {
            window.location.href = 'detail.html?id=' + id;
        }

        // æ·»åŠ åˆ°è´­ç‰©è½¦
        async function addToCart(productId) {
            const user = userStore.getUser();
            if (!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                showLoginModal();
                return;
            }

            try {
                await api.addToCart(user.id, productId, 1);
                alert('âœ… å·²æ·»åŠ åˆ°è´­ç‰©è½¦ï¼');
                updateCartCount();
            } catch (error) {
                alert('âŒ ' + error.message);
            }
        }

        // ==================== ç™»å½•ç›¸å…³ ====================
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('show');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const user = await api.login(username, password);
                userStore.setUser(user);
                closeLoginModal();
                updateUI();
                updateCartCount();
                loadProducts(); // é‡æ–°åŠ è½½ä»¥æ˜¾ç¤ºè´­ä¹°æŒ‰é’®
                alert('âœ… ç™»å½•æˆåŠŸï¼æ¬¢è¿ ' + user.username);
            } catch (error) {
                alert('âŒ ç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }

        function logout() {
            userStore.clearUser();
            updateUI();
            updateCartCount();
            loadProducts();
            alert('å·²é€€å‡ºç™»å½•');
        }

        // ==================== å•†å“ç®¡ç†ï¼ˆç®¡ç†å‘˜ï¼‰ ====================
        function openAddModal() {
            document.getElementById('editModalTitle').textContent = 'æ·»åŠ å•†å“';
            document.getElementById('editId').value = '';
            document.getElementById('editForm').reset();
            document.getElementById('editModal').classList.add('show');
        }

        async function openEditModal(id) {
            try {
                const product = await api.getProduct(id);
                document.getElementById('editModalTitle').textContent = 'ç¼–è¾‘å•†å“';
                document.getElementById('editId').value = product.id;
                document.getElementById('editName').value = product.name;
                document.getElementById('editDescription').value = product.description || '';
                document.getElementById('editPrice').value = product.price;
                document.getElementById('editStock').value = product.stock;
                document.getElementById('editCategory').value = product.category || '';
                document.getElementById('editImageUrl').value = product.imageUrl || '';
                document.getElementById('editModal').classList.add('show');
            } catch (error) {
                alert('è·å–å•†å“ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value;
            const product = {
                name: name,
                description: document.getElementById('editDescription').value,
                price: parseFloat(document.getElementById('editPrice').value),
                stock: parseInt(document.getElementById('editStock').value),
                category: document.getElementById('editCategory').value,
                imageUrl: document.getElementById('editImageUrl').value || '/images/' + name + '.jpg'
            };

            try {
                if (id) {
                    await api.updateProduct(id, product);
                    alert('âœ… æ›´æ–°æˆåŠŸï¼');
                } else {
                    await api.createProduct(product);
                    alert('âœ… æ·»åŠ æˆåŠŸï¼');
                }
                closeEditModal();
                loadProducts();
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function deleteProduct(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
            
            try {
                await api.deleteProduct(id);
                alert('âœ… åˆ é™¤æˆåŠŸï¼');
                loadProducts();
            } catch (error) {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
