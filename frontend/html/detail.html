<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">ğŸ›’ ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <nav class="nav">
                <a href="index.html">å•†å“åˆ—è¡¨</a>
                <a href="cart.html">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“‹ æˆ‘çš„è®¢å•</a>
                <span id="userNav"></span>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html">é¦–é¡µ</a> &gt; <span>å•†å“è¯¦æƒ…</span>
            </div>

            <div id="productDetail" class="product-detail-page">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ - DockeræœŸæœ«é¡¹ç›®</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        var urlParams = new URLSearchParams(window.location.search);
        var productId = urlParams.get('id');
        var currentProduct = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateUserNav();
            loadProductDetail();
        });

        function updateUserNav() {
            var userNav = document.getElementById('userNav');
            var user = userStore.getUser();
            if (user) {
                userNav.innerHTML = '<span style="color:#fff;margin-right:10px;">ğŸ‘¤ ' + user.username + '</span>' +
                    '<a href="#" onclick="logout()">é€€å‡º</a>';
            } else {
                userNav.innerHTML = '<a href="index.html" onclick="showLoginHint()">ğŸ” ç™»å½•</a>';
            }
        }

        function showLoginHint() {
            alert('è¯·åœ¨é¦–é¡µç‚¹å‡»ç™»å½•æŒ‰é’®è¿›è¡Œç™»å½•');
        }

        function loadProductDetail() {
            if (!productId) {
                document.getElementById('productDetail').innerHTML = '<p class="error">æœªæ‰¾åˆ°å•†å“ID</p>';
                return;
            }

            api.getProduct(productId)
                .then(function(product) {
                    currentProduct = product;
                    renderProductDetail(product);
                })
                .catch(function(error) {
                    document.getElementById('productDetail').innerHTML = 
                        '<p class="error">åŠ è½½å¤±è´¥ï¼š' + error.message + '</p>';
                });
        }

        function renderProductDetail(product) {
            var user = userStore.getUser();
            var isLoggedIn = !!user;
            var isAdmin = user && user.role === 'ADMIN';

            var stockStatus = product.stock > 0 ? 
                '<span class="in-stock">âœ… æœ‰è´§ (' + product.stock + 'ä»¶)</span>' : 
                '<span class="out-of-stock">âŒ ç¼ºè´§</span>';

            var html = '<div class="detail-container">' +
                '<div class="detail-image">' +
                '<img src="' + (product.imageUrl || '/images/default.jpg') + '" ' +
                'alt="' + product.name + '" ' +
                'onerror="this.src=\'/images/default.jpg\'">' +
                '</div>' +
                '<div class="detail-info">' +
                '<h1 class="detail-title">' + product.name + '</h1>' +
                '<p class="detail-category">' +
                '<span class="category-tag">' + (product.category || 'æœªåˆ†ç±»') + '</span>' +
                '</p>' +
                '<p class="detail-price">Â¥' + product.price.toFixed(2) + '</p>' +
                '<p class="detail-stock">' + stockStatus + '</p>' +
                '<div class="detail-description">' +
                '<h3>å•†å“æè¿°</h3>' +
                '<p>' + (product.description || 'æš‚æ— æè¿°') + '</p>' +
                '</div>' +
                '<div class="detail-meta">' +
                '<p>å•†å“ID: ' + product.id + '</p>' +
                '<p>åˆ›å»ºæ—¶é—´: ' + new Date(product.createdAt).toLocaleString('zh-CN') + '</p>' +
                '<p>æ›´æ–°æ—¶é—´: ' + new Date(product.updatedAt).toLocaleString('zh-CN') + '</p>' +
                '</div>';

            // è´­ä¹°æ•°é‡é€‰æ‹©å™¨
            if (product.stock > 0) {
                html += '<div class="quantity-selector" style="margin: 20px 0;">' +
                    '<label style="margin-right:10px;">è´­ä¹°æ•°é‡ï¼š</label>' +
                    '<button onclick="changeQty(-1)" class="qty-btn">-</button>' +
                    '<input type="number" id="buyQuantity" value="1" min="1" max="' + product.stock + '" ' +
                    'style="width:60px;text-align:center;margin:0 10px;padding:8px;">' +
                    '<button onclick="changeQty(1)" class="qty-btn">+</button>' +
                    '</div>';
            }

            html += '<div class="detail-actions">';

            // å·²ç™»å½•ä¸”æœ‰åº“å­˜æ˜¾ç¤ºè´­ä¹°æŒ‰é’®
            if (isLoggedIn && product.stock > 0) {
                html += '<button onclick="addToCart()" class="btn btn-primary">ğŸ›’ åŠ å…¥è´­ç‰©è½¦</button>' +
                    '<button onclick="buyNow()" class="btn btn-secondary">ğŸ’³ ç«‹å³è´­ä¹°</button>';
            } else if (!isLoggedIn) {
                html += '<p style="color:#e74c3c;margin-bottom:15px;">âš ï¸ è¯·å…ˆ <a href="index.html">ç™»å½•</a> åè´­ä¹°</p>';
            } else if (product.stock <= 0) {
                html += '<p style="color:#e74c3c;margin-bottom:15px;">âš ï¸ å•†å“æš‚æ—¶ç¼ºè´§</p>';
            }

            // ç®¡ç†å‘˜æ˜¾ç¤ºç¼–è¾‘åˆ é™¤æŒ‰é’®
            if (isAdmin) {
                html += '<button onclick="deleteProduct()" class="btn btn-danger">åˆ é™¤å•†å“</button>';
            }

            html += '<a href="index.html" class="btn btn-secondary">è¿”å›åˆ—è¡¨</a>' +
                '</div></div></div>';

            document.getElementById('productDetail').innerHTML = html;
        }

        function changeQty(delta) {
            var input = document.getElementById('buyQuantity');
            if (!input) return;
            var qty = parseInt(input.value) + delta;
            qty = Math.max(1, Math.min(qty, currentProduct.stock));
            input.value = qty;
        }

        function addToCart() {
            var user = userStore.getUser();
            if (!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'index.html';
                return;
            }

            var quantity = parseInt(document.getElementById('buyQuantity').value);
            
            api.addToCart(user.id, currentProduct.id, quantity)
                .then(function() {
                    alert('âœ… å·²æ·»åŠ åˆ°è´­ç‰©è½¦ï¼');
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function buyNow() {
            var user = userStore.getUser();
            if (!user) {
                alert('è¯·å…ˆç™»å½•ï¼');
                window.location.href = 'index.html';
                return;
            }

            var quantity = parseInt(document.getElementById('buyQuantity').value);
            var address = prompt('è¯·è¾“å…¥æ”¶è´§åœ°å€ï¼š');
            if (!address) return;

            api.createOrder({
                userId: user.id,
                shippingAddress: address,
                items: [{ productId: currentProduct.id, quantity: quantity }]
            })
            .then(function(order) {
                alert('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·ï¼š' + order.orderNo);
                window.location.href = 'orders.html';
            })
            .catch(function(error) {
                alert('âŒ ' + error.message);
            });
        }

        function deleteProduct() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
            
            api.deleteProduct(currentProduct.id)
                .then(function() {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    window.location.href = 'index.html';
                })
                .catch(function(error) {
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message);
                });
        }

        function logout() {
            userStore.clearUser();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
