<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">âš™ï¸ ç®¡ç†åå°</h1>
            <nav class="nav">
                <a href="index.html">è¿”å›å‰å°</a>
                <a href="#" onclick="showTab('products')" id="tabProducts" class="active">ğŸ“¦ å•†å“ç®¡ç†</a>
                <a href="#" onclick="showTab('orders')" id="tabOrders">ğŸ“‹ è®¢å•ç®¡ç†</a>
                <span id="userNav"></span>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- å•†å“ç®¡ç† -->
            <div id="productsPanel" class="admin-panel">
                <div class="panel-header">
                    <h2>ğŸ“¦ å•†å“ç®¡ç†</h2>
                    <button onclick="openAddProduct()" class="btn btn-primary">+ æ·»åŠ å•†å“</button>
                </div>
                <div id="productTable" class="table-container">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è®¢å•ç®¡ç† -->
            <div id="ordersPanel" class="admin-panel" style="display:none;">
                <div class="panel-header">
                    <h2>ğŸ“‹ è®¢å•ç®¡ç†</h2>
                    <select id="adminStatusFilter" class="filter-select" onchange="loadAllOrders()">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="PENDING">å¾…ä»˜æ¬¾</option>
                        <option value="PAID">å·²ä»˜æ¬¾</option>
                        <option value="SHIPPED">å·²å‘è´§</option>
                        <option value="DELIVERED">å·²é€è¾¾</option>
                        <option value="CANCELLED">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div id="orderTable" class="table-container">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- å•†å“ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2 id="productModalTitle">æ·»åŠ å•†å“</h2>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>å•†å“åç§° <span class="required">*</span></label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>å•†å“æè¿°</label>
                    <textarea id="productDesc" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ä»·æ ¼ <span class="required">*</span></label>
                        <input type="number" id="productPrice" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>åº“å­˜ <span class="required">*</span></label>
                        <input type="number" id="productStock" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="productCategory">
                        <option value="ç”µå­äº§å“">ç”µå­äº§å“</option>
                        <option value="æœè£…">æœè£…</option>
                        <option value="é£Ÿå“">é£Ÿå“</option>
                        <option value="å®¶å±…">å®¶å±…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡è·¯å¾„</label>
                    <input type="text" id="productImage" placeholder="/images/å•†å“åç§°.jpg">
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ - ç®¡ç†åå°</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        var statusMap = {
            'PENDING': { text: 'â³ å¾…ä»˜æ¬¾', className: 'status-pending' },
            'PAID': { text: 'âœ… å·²ä»˜æ¬¾', className: 'status-paid' },
            'SHIPPED': { text: 'ğŸšš å·²å‘è´§', className: 'status-shipped' },
            'DELIVERED': { text: 'ğŸ“¦ å·²é€è¾¾', className: 'status-delivered' },
            'CANCELLED': { text: 'âŒ å·²å–æ¶ˆ', className: 'status-cancelled' }
        };

        document.addEventListener('DOMContentLoaded', function() {
            checkAdmin();
            updateUserNav();
            loadProducts();
        });

        function checkAdmin() {
            var user = userStore.getUser();
            if (!user || user.role !== 'ADMIN') {
                alert('âš ï¸ éœ€è¦ç®¡ç†å‘˜æƒé™');
                window.location.href = 'index.html';
            }
        }

        function updateUserNav() {
            var userNav = document.getElementById('userNav');
            var user = userStore.getUser();
            if (user) {
                userNav.innerHTML = '<span style="color:#fff;margin-right:10px;">ğŸ‘¤ ' + user.username + ' (ç®¡ç†å‘˜)</span>' +
                    '<a href="#" onclick="logout()">é€€å‡º</a>';
            }
        }

        function showTab(tab) {
            document.getElementById('productsPanel').style.display = tab === 'products' ? 'block' : 'none';
            document.getElementById('ordersPanel').style.display = tab === 'orders' ? 'block' : 'none';
            document.getElementById('tabProducts').className = tab === 'products' ? 'active' : '';
            document.getElementById('tabOrders').className = tab === 'orders' ? 'active' : '';
            
            if (tab === 'orders') loadAllOrders();
        }

        // ==================== å•†å“ç®¡ç† ====================
        function loadProducts() {
            api.getProducts({ size: 100 })
                .then(function(data) {
                    var products = data.content || data;
                    renderProductTable(products);
                })
                .catch(function(error) {
                    document.getElementById('productTable').innerHTML = 
                        '<div class="error">' + error.message + '</div>';
                });
        }

        function renderProductTable(products) {
            if (products.length === 0) {
                document.getElementById('productTable').innerHTML = '<p>æš‚æ— å•†å“</p>';
                return;
            }

            var html = '<table class="data-table">' +
                '<thead><tr>' +
                '<th>ID</th><th>å›¾ç‰‡</th><th>åç§°</th><th>åˆ†ç±»</th><th>ä»·æ ¼</th><th>åº“å­˜</th><th>æ“ä½œ</th>' +
                '</tr></thead><tbody>';

            products.forEach(function(p) {
                html += '<tr>' +
                    '<td>' + p.id + '</td>' +
                    '<td><img src="' + (p.imageUrl || '/images/default.jpg') + '" style="width:50px;height:50px;object-fit:cover;" onerror="this.src=\'/images/default.jpg\'"></td>' +
                    '<td>' + p.name + '</td>' +
                    '<td>' + (p.category || '-') + '</td>' +
                    '<td>Â¥' + p.price.toFixed(2) + '</td>' +
                    '<td>' + p.stock + '</td>' +
                    '<td>' +
                    '<button onclick="editProduct(' + p.id + ')" class="btn btn-secondary btn-sm">ç¼–è¾‘</button> ' +
                    '<button onclick="deleteProduct(' + p.id + ')" class="btn btn-danger btn-sm">åˆ é™¤</button>' +
                    '</td></tr>';
            });

            html += '</tbody></table>';
            document.getElementById('productTable').innerHTML = html;
        }

        function openAddProduct() {
            document.getElementById('productModalTitle').textContent = 'æ·»åŠ å•†å“';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productModal').classList.add('show');
        }

        function editProduct(id) {
            api.getProduct(id)
                .then(function(product) {
                    document.getElementById('productModalTitle').textContent = 'ç¼–è¾‘å•†å“';
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productDesc').value = product.description || '';
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productStock').value = product.stock;
                    document.getElementById('productCategory').value = product.category || '';
                    document.getElementById('productImage').value = product.imageUrl || '';
                    document.getElementById('productModal').classList.add('show');
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('show');
        }

        function saveProduct(event) {
            event.preventDefault();
            var id = document.getElementById('productId').value;
            var name = document.getElementById('productName').value;
            var product = {
                name: name,
                description: document.getElementById('productDesc').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value,
                imageUrl: document.getElementById('productImage').value || '/images/' + name + '.jpg'
            };

            var promise = id ? api.updateProduct(id, product) : api.createProduct(product);
            
            promise.then(function() {
                alert('âœ… ' + (id ? 'æ›´æ–°' : 'æ·»åŠ ') + 'æˆåŠŸ');
                closeProductModal();
                loadProducts();
            }).catch(function(error) {
                alert('âŒ ' + error.message);
            });
        }

        function deleteProduct(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å•†å“ï¼Ÿ')) return;
            
            api.deleteProduct(id)
                .then(function() {
                    alert('âœ… åˆ é™¤æˆåŠŸ');
                    loadProducts();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        // ==================== è®¢å•ç®¡ç† ====================
        function loadAllOrders() {
            var status = document.getElementById('adminStatusFilter').value;
            var params = { size: 100 };
            if (status) params.status = status;
            
            api.getAllOrders(params)
                .then(function(data) {
                    var orders = data.content || data;
                    renderOrderTable(orders);
                })
                .catch(function(error) {
                    document.getElementById('orderTable').innerHTML = 
                        '<div class="error">' + error.message + '</div>';
                });
        }

        function renderOrderTable(orders) {
            if (orders.length === 0) {
                document.getElementById('orderTable').innerHTML = '<p>æš‚æ— è®¢å•</p>';
                return;
            }

            var html = '<table class="data-table">' +
                '<thead><tr>' +
                '<th>è®¢å•å·</th><th>ç”¨æˆ·ID</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th>ä¸‹å•æ—¶é—´</th><th>æ“ä½œ</th>' +
                '</tr></thead><tbody>';

            orders.forEach(function(o) {
                var status = statusMap[o.status] || { text: o.status, className: '' };
                html += '<tr>' +
                    '<td>' + o.orderNo + '</td>' +
                    '<td>' + o.userId + '</td>' +
                    '<td>Â¥' + o.totalAmount.toFixed(2) + '</td>' +
                    '<td><span class="' + status.className + '">' + status.text + '</span></td>' +
                    '<td>' + new Date(o.createdAt).toLocaleString('zh-CN') + '</td>' +
                    '<td>';
                
                if (o.status === 'PAID') {
                    html += '<button onclick="shipOrder(' + o.id + ')" class="btn btn-primary btn-sm">ğŸšš å‘è´§</button> ';
                }
                if (o.status === 'PENDING') {
                    html += '<button onclick="adminCancelOrder(' + o.id + ')" class="btn btn-danger btn-sm">å–æ¶ˆ</button>';
                }
                
                html += '</td></tr>';
            });

            html += '</tbody></table>';
            document.getElementById('orderTable').innerHTML = html;
        }

        function shipOrder(orderId) {
            if (!confirm('ç¡®è®¤å‘è´§ï¼Ÿ')) return;
            
            api.shipOrder(orderId)
                .then(function() {
                    alert('âœ… å‘è´§æˆåŠŸ');
                    loadAllOrders();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function adminCancelOrder(orderId) {
            if (!confirm('ç¡®å®šå–æ¶ˆæ­¤è®¢å•ï¼Ÿ')) return;
            
            api.cancelOrder(orderId)
                .then(function() {
                    alert('âœ… è®¢å•å·²å–æ¶ˆ');
                    loadAllOrders();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function logout() {
            userStore.clearUser();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
