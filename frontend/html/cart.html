<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">ğŸ›’ ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
            <nav class="nav">
                <a href="index.html">å•†å“åˆ—è¡¨</a>
                <a href="cart.html" class="active">ğŸ›’ è´­ç‰©è½¦</a>
                <a href="orders.html">ğŸ“‹ æˆ‘çš„è®¢å•</a>
                <span id="userNav"></span>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <h2 style="margin-bottom: 20px;">ğŸ›’ æˆ‘çš„è´­ç‰©è½¦</h2>
            <div id="cartContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>

    <!-- ç»“ç®—æ¨¡æ€æ¡† -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeCheckoutModal()">&times;</span>
            <h2>ğŸ“¦ ç¡®è®¤è®¢å•</h2>
            <form id="checkoutForm" onsubmit="submitOrder(event)">
                <div class="form-group">
                    <label>æ”¶è´§åœ°å€ <span class="required">*</span></label>
                    <textarea id="shippingAddress" rows="3" required placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€"></textarea>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea id="orderRemark" rows="2" placeholder="è®¢å•å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div id="orderSummary" style="background:#f5f5f5;padding:15px;border-radius:8px;margin-bottom:20px;"></div>
                <button type="submit" class="btn btn-primary" style="width:100%">âœ… æäº¤è®¢å•</button>
            </form>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ç”µå•†æ•°æ®ç®¡ç†ç³»ç»Ÿ - DockeræœŸæœ«é¡¹ç›®</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script>
        var cartItems = [];

        document.addEventListener('DOMContentLoaded', function() {
            updateUserNav();
            loadCart();
        });

        function updateUserNav() {
            var userNav = document.getElementById('userNav');
            var user = userStore.getUser();
            if (user) {
                userNav.innerHTML = '<span style="color:#fff;margin-right:10px;">ğŸ‘¤ ' + user.username + '</span>' +
                    '<a href="#" onclick="logout()">é€€å‡º</a>';
            } else {
                userNav.innerHTML = '<a href="index.html">è¯·å…ˆç™»å½•</a>';
            }
        }

        function loadCart() {
            var user = userStore.getUser();
            if (!user) {
                document.getElementById('cartContent').innerHTML = 
                    '<div class="empty-state">' +
                    '<p>è¯·å…ˆ <a href="index.html">ç™»å½•</a> åæŸ¥çœ‹è´­ç‰©è½¦</p>' +
                    '</div>';
                return;
            }

            api.getCart(user.id)
                .then(function(items) {
                    cartItems = items;
                    renderCart();
                })
                .catch(function(error) {
                    document.getElementById('cartContent').innerHTML = 
                        '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
                });
        }

        function renderCart() {
            var container = document.getElementById('cartContent');
            
            if (cartItems.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state">' +
                    '<p>ğŸ›’ è´­ç‰©è½¦æ˜¯ç©ºçš„</p>' +
                    '<a href="index.html" class="btn btn-primary">å»è´­ç‰©</a>' +
                    '</div>';
                return;
            }

            var totalAmount = 0;
            var itemsHtml = '';
            
            cartItems.forEach(function(item) {
                var subtotal = item.product.price * item.quantity;
                totalAmount += subtotal;
                
                itemsHtml += '<div class="cart-item">' +
                    '<img src="' + (item.product.imageUrl || '/images/default.jpg') + '" ' +
                    'alt="' + item.product.name + '" class="cart-item-image" ' +
                    'onerror="this.src=\'/images/default.jpg\'">' +
                    '<div class="cart-item-info">' +
                    '<h3>' + item.product.name + '</h3>' +
                    '<p class="cart-item-price">Â¥' + item.product.price.toFixed(2) + '</p>' +
                    '<p class="cart-item-stock">åº“å­˜: ' + item.product.stock + '</p>' +
                    '</div>' +
                    '<div class="cart-item-quantity">' +
                    '<button onclick="updateQuantity(' + item.product.id + ', ' + (item.quantity - 1) + ')" ' +
                    'class="qty-btn"' + (item.quantity <= 1 ? ' disabled' : '') + '>-</button>' +
                    '<span class="qty-value">' + item.quantity + '</span>' +
                    '<button onclick="updateQuantity(' + item.product.id + ', ' + (item.quantity + 1) + ')" ' +
                    'class="qty-btn"' + (item.quantity >= item.product.stock ? ' disabled' : '') + '>+</button>' +
                    '</div>' +
                    '<div class="cart-item-subtotal">' +
                    '<p>Â¥' + subtotal.toFixed(2) + '</p>' +
                    '</div>' +
                    '<button onclick="removeItem(' + item.product.id + ')" class="btn btn-danger btn-sm">åˆ é™¤</button>' +
                    '</div>';
            });

            container.innerHTML = 
                '<div class="cart-list">' + itemsHtml + '</div>' +
                '<div class="cart-footer">' +
                '<div class="cart-total">' +
                '<span>å…± ' + cartItems.length + ' ç§å•†å“ï¼Œåˆè®¡ï¼š</span>' +
                '<span class="total-amount">Â¥' + totalAmount.toFixed(2) + '</span>' +
                '</div>' +
                '<div class="cart-actions">' +
                '<button onclick="clearCart()" class="btn btn-secondary">æ¸…ç©ºè´­ç‰©è½¦</button>' +
                '<button onclick="openCheckout()" class="btn btn-primary">ğŸ’³ å»ç»“ç®—</button>' +
                '</div>' +
                '</div>';
        }

        function updateQuantity(productId, quantity) {
            var user = userStore.getUser();
            
            var promise;
            if (quantity <= 0) {
                promise = api.removeFromCart(user.id, productId);
            } else {
                promise = api.updateCartItem(user.id, productId, quantity);
            }
            
            promise.then(function() {
                loadCart();
            }).catch(function(error) {
                alert('âŒ ' + error.message);
            });
        }

        function removeItem(productId) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
            var user = userStore.getUser();
            
            api.removeFromCart(user.id, productId)
                .then(function() {
                    loadCart();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function clearCart() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) return;
            var user = userStore.getUser();
            
            api.clearCart(user.id)
                .then(function() {
                    loadCart();
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function openCheckout() {
            if (cartItems.length === 0) {
                alert('è´­ç‰©è½¦æ˜¯ç©ºçš„');
                return;
            }

            var totalAmount = 0;
            var summaryHtml = '';
            
            cartItems.forEach(function(item) {
                var subtotal = item.product.price * item.quantity;
                totalAmount += subtotal;
                summaryHtml += '<p>' + item.product.name + ' x ' + item.quantity + ' = Â¥' + subtotal.toFixed(2) + '</p>';
            });

            document.getElementById('orderSummary').innerHTML = summaryHtml +
                '<hr style="margin:10px 0;">' +
                '<p style="font-weight:bold;font-size:18px;color:#e74c3c;">æ€»è®¡ï¼šÂ¥' + totalAmount.toFixed(2) + '</p>';

            document.getElementById('checkoutModal').classList.add('show');
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').classList.remove('show');
        }

        function submitOrder(event) {
            event.preventDefault();
            var user = userStore.getUser();
            
            var orderData = {
                userId: user.id,
                shippingAddress: document.getElementById('shippingAddress').value,
                remark: document.getElementById('orderRemark').value
            };

            api.createOrder(orderData)
                .then(function(order) {
                    alert('âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·ï¼š' + order.orderNo);
                    closeCheckoutModal();
                    window.location.href = 'orders.html';
                })
                .catch(function(error) {
                    alert('âŒ ' + error.message);
                });
        }

        function logout() {
            userStore.clearUser();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
